<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
		<!-- 引入 自己的css-->
		<link rel="stylesheet" type="text/css" href="./css/mystely.css" />
		<link rel="stylesheet" href="./css/jquery.mobile-1.4.1.min.css" />
		<script src="./js/jquery.js"></script>
		<script src="./js/jquery.mobile-1.4.1.min.js"></script>
		<script src="./js/store.js"></script>
		<script  type="text/javascript" >
			$( document ).bind( "mobileinit", function() {
			   $.support.cors = true;   
			   $.mobile.allowCrossDomainPages = true;
			});
			$(document).on("pageinit","#index_login",function(){
				islogin();
				//检验本地存储
				function islogin(){
					var user = window.localStorage.getItem("user");
					if(user != null){
						$.mobile.changePage("#main", "fade"); 
						var user=JSON.parse(kget("user"));
						var now_piva=user.W_Piva;
						var now_totle="0";
						$("#now_user").text(user.W_NameCn+"["+user.W_NameIt+"]");	
						$("#now_piva").text(now_piva);
						$("#now_totle").text(now_totle);
					}else{
						$.mobile.changePage("#index_login", "fade"); 
					}
				}
				function signIn(){
					$.ajax({
						url:"http://192.168.1.126/api/login_ajax.php",
						data:{username:$('#username').val()},
						type:'post',
						dataType:'json',
						success:function(data){
							if(data.flag == "1"){
								$.mobile.loading('hide');
								//解析json
								//JSON.parse(students);/
								//转化字符串
								//JSON.stringify(students);
								//存储用户信息
								kset("user",JSON.stringify(data.custom));
								//kclear();
								$.mobile.changePage("#main", "fade"); 
								var user=JSON.parse(kget("user"));
								var now_piva=user.W_Piva;
								var now_totle="0";
								$("#now_user").text(user.W_NameCn+"["+user.W_NameIt+"]");	
								$("#now_piva").text(now_piva);
								$("#now_totle").text(now_totle);
							}else{
								$.mobile.loading('hide');
								$("#login_test p").text(data.msg);	
							}
						}
					});
				}
				// setup signin and signup button events
				$("button").on("click", function(){
					$.mobile.loading( 'show', {
						text: '登录中...',
						textVisible: true,
						theme: 'a',
						html: ""
					});
					signIn();
				});
				
			});

		</script>
        <title>欧华百货移动结算系统</title>
    </head>
    <body>
	<div data-role="page" id="index_login">
		<div data-role="header">
			<h1>欧华百货移动结算系统</h1>
		</div><!-- /header -->
		<div role="main" class="ui-content">
			<div id="login_test">
				<p>欧华百货移动结算系统</p>
			</div>
				<input id="username" name="username" type="text" placeholder="P.iva" />
			<button id="login" >登录</button>
		</div><!-- /content -->
		<div data-role="footer" data-position="fixed">
			<h4>欧华科技2013-2014</h4>
		</div><!-- /footer -->
	</div><!-- /page -->
	<div data-role="page" id="main">
		<div data-role="header">
			<h1>欧华百货移动结算系统</h1>
		</div><!-- /header -->
		<div role="main" class="ui-content">
        	<div class="user_info">
                <div class="ui-grid-b">
                  <div class="ui-block-a"><span>当前用户：</span><span id="now_user"></span></div>
                  <div class="ui-block-b"><span>P.IVA：</span><span id="now_piva"></span></div>
                  <div class="ui-block-c"><span>当前总计：</span><span id="now_totle"></span><span>&euro;</span></div>
                </div>
            </div>
		</div><!-- /content -->
		<div data-role="footer" data-position="fixed">
			<h4>欧华科技2013-2014</h4>
		</div><!-- /footer -->
	</div><!-- /page -->
    </body>
</html>
