<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1"/>
		<!-- 引入 自己的css-->
		<link rel="stylesheet" type="text/css" href="./css/mystely.css" />
		<link rel="stylesheet" href="./css/jquery.mobile-1.4.1.min.css" />
		<script src="./js/jquery.js"></script>
		<script src="./js/jquery.mobile-1.4.1.min.js"></script>
		<script src="./js/store.js"></script>
		<script  type="text/javascript" >
			$( document ).bind( "mobileinit", function() {
			   $.support.cors = true;   
			   $.mobile.allowCrossDomainPages = true;
			});
			
			$(document).on("pageinit","#index_login",function(){
				islogin();
				//检验本地存储
				function islogin(){
					var user = window.localStorage.getItem("user");
					if(user != null){
						$.mobile.changePage("#main", "fade"); 
						var user=JSON.parse(kget("user"));
						var now_piva=user.W_Piva;
						var now_totle="0";
						$("#now_user").text(user.W_NameCn+"["+user.W_NameIt+"]");	
						$("#now_piva").text(now_piva);
						$("#now_totle").text(now_totle);
					}else{
						$.mobile.changePage("#index_login", "fade"); 
					}
				}
				//统计产品并输出
				function count_good(){
					var good_list=JSON.parse(kget("good_list"));
					var totle=0;
					if(good_list!=null){
						$.each(good_list,function(){
							var xiaoji=this.numero*this.S_final;
							//$("#good_view").append("<div class='ui-block-a'><div class='ui-bar ui-bar-a' style='overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'>"+this.NameIt+"</div></div><div class='ui-block-b'><div class='ui-bar ui-bar-a'>"+this.S_final+"</div></div><div class='ui-block-c'><div class='ui-bar ui-bar-a'>"+this.numero+"</div></div><div class='ui-block-d'><div class='ui-bar ui-bar-a'>"+xiaoji.toFixed(2)+"</div></div>");
							$("#good_view").append("<li id='"+this.Barcode+"'><div class='goodright'><div>"+this.Barcode+"</div><div style='overflow:hidden;text-overflow:ellipsis;white-space:nowrap;'>"+this.NameIt+"</div><div>"+this.NameCn+"</div></div><div id='d_"+this.Barcode+"' class='goodleft'><div>价格："+this.S_final+"</div><div>数量："+this.numero+"</div><div>小计："+xiaoji.toFixed(2)+"</div></div><div id='i"+this.Barcode+"' class='shanchu'><a href='#dialog'><img src='./img/delete.png' width='55px' height='70px'/></a></div></li>");
							totle=totle+xiaoji;
						});
					}
					$("#now_totle").text(totle.toFixed(2));
				}
				count_good();
				function signIn(){
					$.ajax({
						url:"http://192.168.1.126/api/login_ajax.php",
						data:{username:$('#username').val()},
						type:'post',
						dataType:'json',
						success:function(data){
							if(data.flag == "1"){
								$.mobile.loading('hide');
								//解析json
								//JSON.parse(students);/
								//转化字符串
								//JSON.stringify(students);
								//存储用户信息
								kset("user",JSON.stringify(data.custom));
								//kclear();
								$.mobile.changePage("#main", "fade"); 
								var user=JSON.parse(kget("user"));
								var now_piva=user.W_Piva;
								var now_totle="0";
								$("#now_user").text(user.W_NameCn+"["+user.W_NameIt+"]");	
								$("#now_piva").text(now_piva);
								$("#now_totle").text(now_totle);
							}else{
								$.mobile.loading('hide');
								$("#login_test p").text(data.msg);	
							}
						}
					});
				}
				// setup signin and signup button events
				$("button").on("click", function(){
					$.mobile.loading( 'show', {
						text: '登录中...',
						textVisible: true,
						theme: 'a',
						html: ""
					});
					signIn();
				});
				$("li").on("swipeleft",function(){
				  	//$.mobile.changePage( "#dialog", { role: "dialog" } );
					$("#tiaoma").text(this.id);
					$("#d_"+this.id).hide(500);
					$("#i"+this.id).show(500);
				});
				$("li").on("swiperight",function(){
				  	//$.mobile.changePage( "#dialog", { role: "dialog" } );
					$("#tiaoma").text(this.id);
					$("#d_"+this.id).show(500);
					$("#i"+this.id).hide(500);
				});
				$("#dialog_si").click(function(){
					var good_list=JSON.parse(kget("good_list"));
					var tiaoma=$("#tiaoma").text();
					$.each(good_list,function(i){
						 if(this.Barcode==tiaoma){
							if(good_list.length==1){
								good_list=null;	
							}else{
								good_list=good_list.splice(i-1,1);
							} 
						 }
					});
					kset("good_list",JSON.stringify(good_list));
				});
			});
			$(document).on("pageinit","#index_login",function(){
				$("#logout").click(function(){
					kclear();
				});
			});
		</script>
        <title>欧华百货移动结算系统</title>
    </head>
    <body>
	<div data-role="page" id="index_login">
		<div data-role="header">
			<h1>欧华百货移动结算系统</h1>
		</div><!-- /header -->
		<div role="main" class="ui-content">
			<div id="login_test">
				<p>欧华百货移动结算系统</p>
			</div>
				<input id="username" name="username" type="text" placeholder="P.iva" />
			<button id="login" >进入系统</button>
		</div><!-- /content -->
		<div data-role="footer" data-position="fixed">
			<h4>欧华科技2013-2014</h4>
		</div><!-- /footer -->
	</div><!-- /page -->
	<div data-role="page" id="main">
		<div data-role="header">
			<h1>欧华百货移动结算系统</h1>
			<a id="logout" href="index.html" data-ajax='false' data-icon="delete" class="ui-btn-right" data-role="button">退出系统</a>
		</div><!-- /header -->
		<div role="main" class="ui-content">
        	<div class="user_info">
			  <div><span>当前用户：</span><span id="now_user"></span></div>
			  <div><span>P.IVA：</span><span id="now_piva"></span></div>
			  <div><span>当前总计：</span><span><span id="now_totle"></span>&euro;</span></div>
            </div>
			<div class="saomiao">
				<a href="saomiao.html" data-ajax='false' data-role="button" data-transition="pop">开始扫描</a>
			</div>
			<div id="good_list" >
				<ul id="good_view" data-role="listview">

				</ul>
			</div>
			<div>
				<a  id="jiesuan" data-role="button" data-transition="pop">结算</a>
			</div>
		</div><!-- /content -->
		<div data-role="footer" data-position="fixed">
			<h4>欧华科技2013-2014</h4>
		</div><!-- /footer -->
	</div><!-- /page -->
	<div data-role="page" id="dialog">
		<div data-role="header">
			<h1>是否确定删除？</h1>
		</div><!-- /header -->
		<div role="main" class="ui-content">
        	<div>是否确定删除<span id="tiaoma"></span>？</div>
        	<div>
                <a id="dialog_si" href="index.html" data-ajax="false" class="ui-btn ui-btn-inline">确定</a>
                <a href="#main" class="ui-btn ui-btn-inline">取消</a>
            </div>
		</div><!-- /content -->
		<div data-role="footer" data-position="fixed">
			<h4>欧华科技2013-2014</h4>
		</div><!-- /footer -->
	</div><!-- /page -->
    </body>
</html>
